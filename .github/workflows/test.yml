name: Tests
on:
  workflow_dispatch: {}
permissions:
  contents: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}
jobs:
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        neovim-version:
        - stable
        - nightly
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        fetch-depth: 0
        persist-credentials: false
    - name: Setup Nix
      uses: nixbuild/nix-quick-install-action@5bb6a3b3abe66fd09bbf250dce8ada94f856a703
    - uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a
      with:
        primary-key: nix-claudecode-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock')
          }}
        restore-prefixes-first-match: nix-claudecode-${{ runner.os }}-
        gc-max-store-size-linux: 2G
        purge: true
        purge-prefixes: nix-claudecode-${{ runner.os }}-
        purge-created: 0
        purge-primary-key: never
    - name: Setup Neovim
      uses: rhysd/action-setup-vim@8e931b9954b19d4203d5caa5ff5521f3bc21dcc7
      with:
        neovim: true
        version: ${{ matrix.neovim-version }}
    - name: Run Luacheck
      run: nix develop .#ci -c make check
    - name: Run tests
      run: nix develop .#ci -c make test
    - name: Check formatting
      run: nix flake check
    - name: Generate coverage report
      run: "if [ -f \"luacov.stats.out\" ]; then\n  nix develop .#ci -c luacov\n\n\
        \  echo \"Creating lcov.info from luacov.report.out\"\n  {\n    echo \"TN:\"\
        \n    grep -E \"^Summary$\" -A1000 luacov.report.out | grep -E \"^[^ ].*:\"\
        \ | while read -r line; do\n      file=$(echo \"$line\" | cut -d':' -f1)\n\
        \      echo \"SF:$file\"\n      percent=$(echo \"$line\" | grep -oE \"[0-9\\\
        .]+%\" | tr -d '%')\n      if [ -n \"$percent\" ]; then\n        echo \"DA:1,1\"\
        \n        echo \"LF:1\"\n        echo \"LH:$percent\"\n      fi\n      echo\
        \ \"end_of_record\"\n    done\n  } > lcov.info\n\n  {\n    echo \"## \U0001F4CA\
        \ Test Coverage Report\"\n    echo \"\"\n\n    if [ -f \"luacov.report.out\"\
        \ ]; then\n      overall_coverage=$(grep -E \"Total.*%\" luacov.report.out\
        \ | grep -oE \"[0-9]+\\.[0-9]+%\" | head -1)\n      if [ -n \"$overall_coverage\"\
        \ ]; then\n        echo \"**Overall Coverage: $overall_coverage**\"\n    \
        \    echo \"\"\n      fi\n\n      echo \"| File | Coverage |\"\n      echo\
        \ \"|------|----------|\"\n\n      grep -E \"^[^ ].*:\" luacov.report.out\
        \ | while read -r line; do\n        file=$(echo \"$line\" | cut -d':' -f1)\n\
        \        percent=$(echo \"$line\" | grep -oE \"[0-9]+\\.[0-9]+%\" | head -1)\n\
        \        if [ -n \"$percent\" ]; then\n          # Add emoji based on coverage\
        \ level\n          percent_num=\"${percent%.*}\"\n          if [ \"$percent_num\"\
        \ -ge 90 ]; then\n            emoji=\"\U0001F7E2\"\n          elif [ \"$percent_num\"\
        \ -ge 70 ]; then\n            emoji=\"\U0001F7E1\"\n          else\n     \
        \       emoji=\"\U0001F534\"\n          fi\n          echo \"| \\`$file\\\
        ` | $emoji $percent |\"\n        fi\n      done\n    else\n      echo \"\u274C\
        \ No coverage report generated\"\n    fi\n  } >> \"$GITHUB_STEP_SUMMARY\"\n\
        else\n  {\n    echo \"## \U0001F4CA Test Coverage Report\"\n    echo \"\"\n\
        \    echo \"\u274C No coverage data found - tests may not have run with coverage\
        \ enabled\"\n  } >> \"$GITHUB_STEP_SUMMARY\"\nfi\n"
  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        neovim-version:
        - stable
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        fetch-depth: 0
        persist-credentials: false
    - name: Setup Nix
      uses: nixbuild/nix-quick-install-action@5bb6a3b3abe66fd09bbf250dce8ada94f856a703
    - uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a
      with:
        primary-key: nix-claudecode-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock')
          }}
        restore-prefixes-first-match: nix-claudecode-${{ runner.os }}-
        gc-max-store-size-linux: 2G
        purge: true
        purge-prefixes: nix-claudecode-${{ runner.os }}-
        purge-created: 0
        purge-primary-key: never
    - name: Setup Neovim
      uses: rhysd/action-setup-vim@8e931b9954b19d4203d5caa5ff5521f3bc21dcc7
      with:
        neovim: true
        version: ${{ matrix.neovim-version }}
    - name: Install test dependencies
      run: 'git clone --depth 1 https://github.com/nvim-lua/plenary.nvim ~/.local/share/nvim/site/pack/vendor/start/plenary.nvim

        ln -s "$(pwd)" ~/.local/share/nvim/site/pack/vendor/start/claudecode.nvim

        '
    - name: Run integration tests
      run: nix develop .#ci -c ./scripts/run_integration_tests_individually.sh
